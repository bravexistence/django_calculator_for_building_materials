{% load static %}
{% load dict_extras %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ö–ü {{ quote.client_name }}</title>
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <style>
    .flex{display:flex;gap:1rem}
    .grow{flex:1 1 0}
    .basis-1\/2{flex-basis:50%}
    .basis-1\/4{flex-basis:25%}
    .pe-6{padding-right:1.5rem}
    .overflow-y-auto{overflow-y:auto}
    .max-h-85{max-height:85vh}
    .text-end{text-align:end}
    .btn{padding:.25rem .75rem;border:1px solid #666;border-radius:4px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:2px 4px}
    thead th{border-bottom:1px solid #aaa;font-weight:600}
  </style>
</head>
<body>

<div class="quote-container flex w-full gap-4">

  <!-- 1. –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ --------------------------------------------------->
  <div class="grow basis-1/4 pe-6 overflow-y-auto max-h-85">
  <p style="margin-top:2rem;"><a href="{% url 'dashboard' %}">‚Üê üè† –ö —Å–ø–∏—Å–∫—É –ö–ü</a></p>
    <h2>–ö–ü –¥–ª—è {{ quote.client_name }}</h2>
    <p><strong>–î–∞—Ç–∞:</strong> {{ quote.created_at|date:"Y-m-d H:i" }}</p>

    <form method="post" novalidate>
      {% csrf_token %}
      {{ form.non_field_errors }}

      <fieldset>
        <legend>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</legend>
        {{ form.materials }}
            <legend>–î–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</legend>
              <p>
                {{ form.special_technique.label_tag }} {{ form.special_technique }} —á
              </p>
              <p>
                {{ form.ultrafiolet_base.label_tag }} {{ form.ultrafiolet_base }}
              </p>
              <p>
                {{ form.ultrafiolet_letters_print.label_tag }} {{ form.ultrafiolet_letters_print }}
              </p>

      </fieldset>

      <!-- —Ä–∞–∑–º–µ—Ä—ã –ø–æ–¥–∫–ª–∞–¥–æ–∫ -->
      <div id="pvh-fields" {% if "–ø–≤—Ö" not in quote.materials %}style="display:none"{% endif %}>
        {{ form.width_pvh.label_tag }} {{ form.width_pvh }} –º<br>
        {{ form.height_pvh.label_tag }} {{ form.height_pvh }} –º
      </div>

      <div id="alyuk-fields" {% if "–∞–ª—é–∫" not in quote.materials %}style="display:none"{% endif %}>
        {{ form.width_alyuk.label_tag }} {{ form.width_alyuk }} –º<br>
        {{ form.height_alyuk.label_tag }} {{ form.height_alyuk }} –º
      </div>

      <h3>–ë–ª–æ–∫–∏</h3>
      {{ formset.management_form }}
      <table id="blocks-table">
        <thead><tr><th>–†–∞–∑–º–µ—Ä</th><th>–ö–æ–ª-–≤–æ</th><th>–£–¥–∞–ª–∏—Ç—å</th></tr></thead>
        <tbody>
          {% for f in formset %}
            <tr>
              {{ f.id }}
              <td>{{ f.letter_size }}</td>
              <td>{{ f.letter_count }}</td>
              <td>
                  {% if f.instance.pk %}
                    {{ f.DELETE }}
                      <button type="button" class="btn btn-delete">üóë</button>
                  {% endif %}
                </td>
          {% endfor %}
        </tbody>
      </table>
    <button type="button" id="add-block" class="btn mt-2">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫</button>

      <template id="empty-form-template">
          <tr>
            {{ formset.empty_form.id }}
            <td>{{ formset.empty_form.letter_size }}</td>
            <td>{{ formset.empty_form.letter_count }}</td>
            <td><button type="button" class="btn btn-delete">üóë</button></td>
          </tr>
        </template>

      <button type="submit" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>

    <hr><h3>–ò—Ç–æ–≥</h3>

    <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> {{ quote.client_name }}</p>
    <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ quote.created_at|date:"Y-m-d H:i" }}</p>

    <p><strong>–í—Å–µ–≥–æ –±—É–∫–≤:</strong> {{ quote.total_letters }}</p>
    <p><strong>–ö–æ–ª-–≤–æ –¥–∏–æ–¥–æ–≤:</strong> {{ quote.total_diodes }}</p>
    <p><strong>–ö–æ–ª-–≤–æ –∫–ª–µ—è:</strong> {{ quote.total_glue }}</p>
    <p><strong>–ê–∫—Ä–∏–ª –º¬≤:</strong> {{ quote.total_acrylic }}</p>
    <p><strong>–ü–í–• –º¬≤:</strong> {{ quote.total_pvc }}</p>
    <p><strong>–ö–æ–ª-–≤–æ –ø–æ–ª–æ—Å:</strong> {{ quote.total_stripes }}</p>
    <p><strong>–û—Ä–∞–∫–∞–ª –º¬≤:</strong> {{ quote.total_oracal_m2 }}</p>
    <p><strong>–ü—Ä–æ–≤–æ–¥–∞ –º.–ø.:</strong> {{ quote.total_wire_m }}</p>
    <p><strong>–ú–æ—â–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä–∞ (–í—Ç):</strong> {{ quote.total_power_watt }}</p>
    <p><strong>–õ–∏—Å—Ç–æ–≤:</strong> {{ quote.sheets }}</p>
    <p><strong>–ü—Ä–æ—Ñ–∏–ª—å –®–¢:</strong> {{ quote.profile }}</p>
    <p><strong>–°–∏–ª–∏–∫–æ–Ω:</strong> {{ quote.silicone }}</p>
    <p><strong>–û—Ä–∞–∫–∞–ª:</strong> {{ quote.oracal }}</p>
    <p><strong>–ó–∞–¥–Ω–∏–∫–∏:</strong> {{ quote.total_back }}</p>
    <p><strong>–õ–∏—Å—Ç–æ–≤ –Ω–∞ –ª–∏—Ü–µ–≤—ã–µ:</strong> {{ quote.face_sheets }}</p>
    <p><strong>–õ–∏—Å—Ç–æ–≤ –Ω–∞ –ø–æ–ª–æ—Å—ã:</strong> {{ quote.stripe_sheets }}</p>
    <p><strong>–ü/–º –æ—Ä–∞–∫–∞–ª 1 –º —à–∏—Ä–∏–Ω–∞:</strong> {{ quote.oracal_pm_1m }}</p>
    <p><strong>–ü/–º –æ—Ä–∞–∫–∞–ª 1,2 –º —à–∏—Ä–∏–Ω–∞:</strong> {{ quote.oracal_pm_1_2m }}</p>

    {% if "–ø–≤—Ö" in quote.materials %}
      <p><strong>–®–∏—Ä–∏–Ω–∞ –ü–í–• (–º):</strong> {{ quote.width_pvh }}</p>
      <p><strong>–í—ã—Å–æ—Ç–∞ –ü–í–• (–º):</strong> {{ quote.height_pvh }}</p>
      <p><strong>–ü–ª–æ—â–∞–¥—å –ü–í–•:</strong> {{ quote.area_pvh }}</p>
    {% endif %}
    {% if "–∞–ª—é–∫" in quote.materials %}
      <p><strong>–®–∏—Ä–∏–Ω–∞ –ê–ª—é–∫–æ–±–æ–Ω–¥–∞ (–º):</strong> {{ quote.width_alyuk }}</p>
      <p><strong>–í—ã—Å–æ—Ç–∞ –ê–ª—é–∫–æ–±–æ–Ω–¥–∞ (–º):</strong> {{ quote.height_alyuk }}</p>
      <p><strong>–ü–ª–æ—â–∞–¥—å –ê–ª—é–∫–æ–±–æ–Ω–¥–∞:</strong> {{ quote.area_alyuk }}</p>
    {% endif %}
    <p><strong>–ü–ª–æ—â–∞–¥—å –≤—ã–≤–µ—Å–∫–∏:</strong> {{ quote.area }} –º¬≤</p>


  </div>

    <!-- 2. –°—Ä–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞ ------------------------------------------------->
    <aside class="basis-1/4 pe-6 overflow-y-auto max-h-85">
      <h3>–¢–∏–ø—ã –≤—ã–≤–µ—Å–æ–∫</h3>
            {% if messages %}
          {% for m in messages %}
            <div style="color:red; margin-bottom:10px;">{{ m }}</div>
          {% endfor %}
        {% endif %}
        <div class="flex gap-2">
          <button type="button" class="btn text-xs" style="height:30px"
                  onclick="setAllVariants(true)">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ</button>
          <button type="button" class="btn text-xs" style="height:30px"
                  onclick="setAllVariants(false)">–°–Ω—è—Ç—å –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è</button>
        </div>

      <form method="post" action="{% url 'set_variants' quote.id %}"
      class="w-full" style="margin-top:1rem">
        {% csrf_token %}
        {% for code, label in sign_types.items %}
          {% with v=quote.variants|get_item:code %}
            <div class="flex items-center mb-2">
              <label class="flex items-center gap-2">
                <input type="checkbox" name="use_{{ code }}"
                       class="variant-checkbox"
                       {% if not v or v.use_in_offer %}checked{% endif %}>
                <span class="whitespace-nowrap">{{ label }}</span>
              </label>
              <div class="flex items-center gap-1 text-sm text-gray-500" style="margin-left:auto">
                <span>–ù–∞—Ü–µ–Ω–∫–∞:</span>
                <input type="number" name="margin_{{ code }}" min="0" max="300"
                       value="{{ v.margin_pct|default_if_none:'0' }}"
                       style="width: 35px; font-size: 10px; padding: 1px 3px; height: 20px;"> %
              </div>
            </div>
          {% endwith %}
        {% endfor %}
        <button class="btn" type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã</button>
      </form>
    </aside>

    <script>
    function setAllVariants(value) {
      document.querySelectorAll('.variant-checkbox').forEach(cb => cb.checked = value);
    }
    </script>


<!-- 3. –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -------------------------------------------------->
<aside class="basis-1/2 pe-6 overflow-y-auto max-h-85">
  <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ö–ü</h3>

  {% for v in quote.variants.all %}
    {% if v.use_in_offer %}
      <details class="mb-4 variant-box">
        <summary class="variant-summary">
          {{ sign_types|get_item:v.type_code }}
          <span class="variant-total">{{ v.subtotal }} ‚Ç∏</span>
        </summary>

        <table class="variant-table">
          {% for it in v.items.all %}
            <tr>
              <td class="pr-2 py-1">{{ it.name }}</td>
              <td class="text-end pr-2 py-1 whitespace-nowrap">{{ it.qty }} {{ it.unit }}</td>
              <td class="text-end py-1 whitespace-nowrap">{{ it.subtotal }} ‚Ç∏</td>
            </tr>
          {% endfor %}
          <tr class="font-bold">
            <td colspan="2" class="text-end pt-2">–ò—Ç–æ–≥–æ:</td>
            <td class="text-end pt-2">{{ v.subtotal }} ‚Ç∏</td>
          </tr>
        </table>
      </details>
    {% endif %}
  {% endfor %}
<p>
  <a href="{% url 'quote_pdf' quote.id %}" class="btn" target="_blank">üìÑ –°–∫–∞—á–∞—Ç—å PDF</a>
</p>
</aside>

</div>

<script>
  // –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª—è –ø–æ–¥–∫–ª–∞–¥–æ–∫
  document.querySelectorAll('input[name="materials"]').forEach(i=>{
    i.addEventListener('change',()=>{
      document.getElementById('pvh-fields').style.display =
        document.querySelector('input[value="–ø–≤—Ö"]').checked ? '' : 'none';
      document.getElementById('alyuk-fields').style.display =
        document.querySelector('input[value="–∞–ª—é–∫"]').checked ? '' : 'none';
    });
  });
</script>

<script>
  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤
  document.getElementById("add-block").addEventListener("click", () => {
    const template = document.getElementById("empty-form-template").innerHTML;
    const tbody = document.querySelector("#blocks-table tbody");
    const totalForms = document.querySelector("#id_blocks-TOTAL_FORMS");
    const newIndex = parseInt(totalForms.value);

    const newRowHtml = template.replace(/__prefix__/g, newIndex);
    const newRow = document.createElement("tr");
    newRow.innerHTML = newRowHtml;

    newRow.querySelector(".btn-delete").addEventListener("click", () => {
      newRow.remove();
    });

    tbody.appendChild(newRow);
    totalForms.value = newIndex + 1;
  });

// –£–¥–∞–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±–ª–æ–∫–æ–≤
document.querySelectorAll("#blocks-table .btn-delete").forEach(btn => {
  btn.addEventListener("click", () => {
    const row = btn.closest("tr");
    const deleteBox = row.querySelector("input[name$='-DELETE']");

    if (deleteBox) {          // —ç—Ç–æ –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –±–ª–æ–∫
      deleteBox.checked = true;   // ‚Üê —Å—Ç–∞–≤–∏–º –≥–∞–ª–æ—á–∫—É!
      row.style.display = "none"; // –ø—Ä—è—á–µ–º —Å—Ç—Ä–æ–∫—É
    } else {                  // —ç—Ç–æ –ù–û–í–´–ô (–µ—â—ë –±–µ–∑ pk) ‚Äì –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º
      row.remove();
      // –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ —É–º–µ–Ω—å—à–∏—Ç—å TOTAL_FORMS ‚Äì –¥–æ–ø–∏—à–∏ —Å—á—ë—Ç—á–∏–∫
    }
  });
});
</script>
</body>
</html>
